jQuery.cookie=function(name,value,options){if(typeof value!="undefined"){options=options||{};if(value===null){value="";options.expires=-1}var expires="";if(options.expires&&(typeof options.expires=="number"||options.expires.toUTCString)){var date;if(typeof options.expires=="number"){date=new Date;date.setTime(date.getTime()+options.expires*24*60*60*1E3)}else date=options.expires;expires="; expires="+date.toUTCString()}var path=options.path?"; path="+options.path:"";var domain=options.domain?"; domain="+
options.domain:"";var secure=options.secure?"; secure":"";document.cookie=[name,"=",encodeURIComponent(value),expires,path,domain,secure].join("")}else{var cookieValue=null;if(document.cookie&&document.cookie!=""){var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}};
(function($){$.gt=$.gt||{};$.extend($.gt,{messages:{},lang:"C",setLang:function(code){$.gt.lang=typeof code=="string"&&code!=" "?code:"C"},pl_re:/^Plural-Forms:\s*nplurals\s*=\s*(\d+);\s*plural\s*=\s*([^a-zA-Z0-9\$]*([a-zA-Z0-9\$]+).+)$/m,plural:function(n){return n!=1},load:function(){$("link[rel=gettext]").each(function(){var lang=this.lang;$.get(this.href,function(data){$.gt.messages[lang]=$.gt.messages[lang]||{};try{var messages=eval("("+data+")")}catch(e){return}$.extend($.gt.messages[lang],
messages);var pl=$.gt.pl_re.exec($.gt.messages[lang][""]);if(pl){var expr=pl[2];var np=pl[1];var v=pl[3];try{var fn=eval("(function("+v+") {return "+expr+";})")}catch(e){return}$.gt.plural=fn}})});$.gt.setLang($("html").attr("lang"))},gettext:function(msgstr){var lang=$.gt.lang;if(lang=="C"||typeof $.gt.messages[lang]=="undefined")return msgstr;var trans=$.gt.messages[lang][msgstr];if(typeof trans=="string")return trans;else if(typeof trans=="object"&&trans.constructor==Array)return trans[0];return msgstr},
ngettext:function(){var lang=$.gt.lang;var argv=Array.apply(null,arguments);var cnt=argv[argv.length-1];var sg=argv[0];var pls=argv.slice(0,-1);var trans=pls;if(lang!="C"&&typeof $.gt.messages[lang]!="undefined")trans=$.gt.messages[lang][sg];if(typeof trans=="string")return trans;else if(typeof trans=="object"&&trans.constructor==Array){var pl=$.gt.plural(cnt);if(typeof pl=="boolean"&&pls.length==2)pl=pl?1:0;if(typeof pl=="number"&&pl<trans.length)return trans[pl]}return sg}});$("document").ready($.gt.load)})(jQuery);
if(typeof _=="undefined")var _=jQuery.gt.gettext;if(typeof n_=="undefined")var n_=jQuery.gt.ngettext;var debug=true;var show_log=false;var mapEventlisteners=false;var proj4326=new OpenLayers.Projection("EPSG:4326");var projmerc=new OpenLayers.Projection("EPSG:900913");OpenLayers.Util.onImageLoadError=function(){this.src="static/gfx/openlayers/tile_not_found.gif"};OpenLayers.Tile.Image.useBlankTile=false;
$(document).ready(function(){if(debug==true){var log=$("#log").attr("style","position:absolute; top: 100px; left: 100px;");log.draggable({handle:"#log .handle"});$("#log ul").resizable({alsoResize:"#log"});$("#developers").append(' &bull; <a href="#" id="toggle_log">'+_("Toggle log")+"</a>");$("#toggle_log").click(function(e){e.preventDefault();log.toggle()});if(show_log==true)log.show();else log.hide()}fetchlocation();$("div#map").text("");init_map();$("a.pagelink").each(function(index){$(this).click(function(e){e.preventDefault();
open_page(this.id);$(this).blur()})});$("a.cardlink").each(function(index){$(this).click(function(e){e.preventDefault();open_card(this.id,$(this).text());$(this).blur()})});$("#search_form").submit(function(){search($("#search_form input#q").val());return false});$("#search_form input#q").autocomplete({source:function(request,response){$.ajax({url:"http://ws.geonames.org/searchJSON",dataType:"jsonp",data:{featureClass:"P",style:"full",maxRows:10,name_startsWith:request.term},success:function(data){response($.map(data.geonames,
function(item){return{label:item.name+(item.adminName1?", "+item.adminName1:"")+", "+item.countryName,value:item.name+(item.adminName1?", "+item.adminName1:"")+", "+item.countryName}}))}})},minLength:2,select:function(event,ui){search(ui.item.label)},open:function(){$(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){$(this).removeClass("ui-corner-top").addClass("ui-corner-all")}});$("form#language_selection input#submit").hide();$("form#language_selection select").change(function(){$("form#language_selection input#submit").click()});
if($("#LoginNavi").hasClass("logged_out")){maps_debug("Initialize the login form");$("#loginPanel").hide();$("#loginOpener").click(function(e){e.preventDefault();if($(this).hasClass("open")){maps_debug("Close login slider.");$(this).removeClass("open");$("#loginPanel").slideUp("fast");$(this).blur()}else{maps_debug("Open login slider.");$(this).addClass("open");$("#loginPanel").slideDown("fast");$("input#email").focus()}});$("#login_form").submit(function(){maps_debug("Login submitted.");stats("login/");
$(this).hide();$("#loginPanel .loading").show();var p_email=$("#Login #email").val();var p_password=$("#Login #password").val();var p_remember=$("#Login #remember_me").val();if(p_email==""||p_password=="")info_dialog(_("Please type in your email and password"),_("Login failed"),true);else{maps_debug("Requesting to login: "+p_email);$.post("ajax/login.php",{email:p_email,password:p_password,remember:p_remember},function(data){maps_debug("Got login responce, login: "+data.login);p_email=false;p_password=
false;if(data.login==true)$("#reloadPage input").click();else if(data.login==false){$("#loginPanel .loading").hide();$("#login_form").show();info_dialog("<p><strong>"+_("Incorrect email or password.")+'</strong></p><p><a href="./?page=lost_password">'+_("Lost your password?")+"</a></p>",_("Login failed"),true)}else{$("#loginPanel .loading").hide();$("#login_form").show();info_dialog(_("Mystical error with login, please try again."),_("Login failed"),true)}},"json")}return false})}$("#pages .close").click(function(e){e.preventDefault();
close_page()});$("#pages .page .content, #pages .page, #pages .close").hide();$("#map_selector").show();$("#map_selector #selected_map").click(function(e){e.preventDefault();$("#map_selector #maplist").slideToggle("fast")});$("#map_selector #maplist li a").click(function(e){e.preventDefault();$("#map_selector #maplist").slideToggle("fast");var thisLink=$(this);$("#map_selector #selected_map .map_name").text(thisLink.text());$("#map_selector #maplist li a").removeClass("selected");thisLink.addClass("selected")});
$("#Navigation #add_place").click(function(e){e.preventDefault();stats("add_place/");init_add_place()});$("#Navigation #tools, div#toolsPanel h4 .close").click(function(e){e.preventDefault();stats("toggle_tools/");$(this).blur();$("div#toolsPanel").toggle();close_page()});$("div#toolsPanel").draggable({handle:"h4"}).attr("style","text-align:left; top: 100px; left: 240px;");$("div#toolsPanel #zoom_slider").slider({range:"max",min:0,max:18,value:markersZoomLimit,slide:function(event,ui){$("div#toolsPanel #zoom_slider_amount").text(ui.value);
markersZoomLimit=ui.value;if(ui.value<=6){$("div#toolsPanel #zoomlevel *").hide();$("div#toolsPanel #zoomlevel .z_continent").show()}else if(ui.value<=10){$("div#toolsPanel #zoomlevel *").hide();$("div#toolsPanel #zoomlevel .z_country").show()}else if(ui.value<=14){$("div#toolsPanel #zoomlevel *").hide();$("div#toolsPanel #zoomlevel .z_city").show()}else{$("div#toolsPanel #zoomlevel *").hide();$("div#toolsPanel #zoomlevel .z_streets").show()}$.cookie(cookie_prefix+"markersZoomLimit",ui.value,{path:"/",
expires:666});refreshMapMarkers()}});$("div#toolsPanel #zoom_slider_amount").text($("#toolsPanel #zoom_slider").slider("value"));$("div#toolsPanel, #loading-bar").hide();var sidebar_height=$("#Sidebar").height();$("div#map").attr("style","min-height: "+sidebar_height+"px")});var map,places,map_center;var handle_add_place_click=false;
function init_map(){maps_debug("Initialize the map");OpenLayers.ImgPath="static/gfx/openlayers/";map=new OpenLayers.Map("map",{projection:proj4326,displayProjection:projmerc,units:"m",numZoomLevels:18,maxResolution:156543.0339,maxExtent:new OpenLayers.Bounds(-20037508,-20037508,20037508,2.003750834E7),eventListeners:{move:mapEventMoveStarted,moveend:mapEventMove,zoomend:mapEventZoom,changelayer:mapLayerChanged,changebaselayer:mapBaseLayerChanged},controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar,
new OpenLayers.Control.ScaleLine,new OpenLayers.Control.OverviewMap]});var sketchSymbolizers={Point:{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#db7700"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#333",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#333",fillColor:"white",fillOpacity:0.3}};var style=new OpenLayers.Style;style.addRules([new OpenLayers.Rule({symbolizer:sketchSymbolizers})]);var styleMap=
new OpenLayers.StyleMap({"default":style});measureControls={line:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}}}),polygon:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}}})};var control;for(var key in measureControls){control=measureControls[key];control.geodesic=true;control.events.on({measure:handleMeasurements,measurepartial:handleMeasurements});map.addControl(control)}document.getElementById("noneToggle").checked=
true;var colors=["#ffffff","#00ad00","#96ad00","#ffff00","#ff8d00","#ff0000"];var markerContext={getColor:function(feature){return colors[feature.attributes["rating"]]}};places=new OpenLayers.Layer.Vector("Places",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({graphicZIndex:1,pointRadius:5,strokeWidth:2,cursor:"pointer",fillColor:"#000000",strokeColor:"${getColor}"},{context:markerContext}),select:new OpenLayers.Style({graphicZIndex:2,fillColor:"#66ccff",strokeColor:"#3399ff"}),
hover:new OpenLayers.Style({graphicZIndex:2,fillColor:"#3399ff"})}),isBaseLayer:false,rendererOptions:{yOrdering:true}});places.events.on({featureselected:function(event){feature=event.feature;maps_debug("Selected marker "+feature.attributes.id);showPlacePanel(feature.attributes.id)},featureunselected:function(feature){maps_debug("Unselected marker.");hidePlacePanel()}});places_count=new OpenLayers.Layer.Vector("Places count",{styleMap:new OpenLayers.StyleMap({fillOpacity:1,fillColor:"#fde669",strokeColor:"#c38b06",
strokeWidth:1,pointRadius:"${radius}",cursor:"pointer",label:"${places}",fontColor:"#824300",fontSize:"10px",fontFamily:"'Trebuchet MS',Arial,sans-serif",fontWeight:"bold",labelAlign:"cm"}),isBaseLayer:false,rendererOptions:{yOrdering:true}});add_place_target=new OpenLayers.Layer.Vector("New place",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({cursor:"move",graphicZIndex:3,pointRadius:7,strokeWidth:5,strokeColor:"#f57900",fillColor:"#f57900",fillOpacity:0}),hover:new OpenLayers.Style({strokeColor:"#ff9834"})}),
isBaseLayer:false});var hover_new_place=new OpenLayers.Control.SelectFeature(add_place_target,{hover:true,highlightOnly:true,renderIntent:"hover"});map.addControl(hover_new_place);hover_new_place.activate();var mapnik=new OpenLayers.Layer.OSM;var osmarender=new OpenLayers.Layer.OSM("OpenStreetMap (Tiles@Home)","http://tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png");if(layer_google==true){var gphy=new OpenLayers.Layer.Google("Google Physical",{visibility:false,sphericalMercator:true,type:G_PHYSICAL_MAP});
var gmap=new OpenLayers.Layer.Google("Google Streets",{visibility:false,sphericalMercator:true,numZoomLevels:20});var ghyb=new OpenLayers.Layer.Google("Google Hybrid",{visibility:false,sphericalMercator:true,type:G_HYBRID_MAP,numZoomLevels:20});var gsat=new OpenLayers.Layer.Google("Google Satellite",{visibility:false,sphericalMercator:true,type:G_SATELLITE_MAP,numZoomLevels:22})}if(layer_yahoo==true){var yahoo=new OpenLayers.Layer.Yahoo("Yahoo Street",{visibility:false,sphericalMercator:true});var yahoosat=
new OpenLayers.Layer.Yahoo("Yahoo Satellite",{visibility:false,type:YAHOO_MAP_SAT,sphericalMercator:true});var yahoohyb=new OpenLayers.Layer.Yahoo("Yahoo Hybrid",{visibility:false,type:YAHOO_MAP_HYB,sphericalMercator:true})}if(layer_vearth==true){var veroad=new OpenLayers.Layer.VirtualEarth("Virtual Earth Roads",{visibility:false,type:VEMapStyle.Road,sphericalMercator:true});var veaer=new OpenLayers.Layer.VirtualEarth("Virtual Earth Aerial",{visibility:false,type:VEMapStyle.Aerial,sphericalMercator:true});
var vehyb=new OpenLayers.Layer.VirtualEarth("Virtual Earth Hybrid",{visibility:false,type:VEMapStyle.Hybrid,sphericalMercator:true})}if(layer_google==true)map.addLayers([gphy,gmap,ghyb,gsat]);if(layer_yahoo==true)map.addLayers([yahoo,yahoosat,yahoohyb]);if(layer_vearth==true)map.addLayers([veroad,veaer,vehyb]);map.addLayers([mapnik,osmarender,places,places_count,add_place_target]);add_place_target.setVisibility(false);if(layer_default=="mapnik")map.setBaseLayer(mapnik);else if(layer_default=="osmarender")map.setBaseLayer(osmarender);
else if(layer_default=="gphy"&&layer_google==true)map.setBaseLayer(gphy);else if(layer_default=="gmap"&&layer_google==true)map.setBaseLayer(gmap);else if(layer_default=="ghyb"&&layer_google==true)map.setBaseLayer(ghyb);else if(layer_default=="gsat"&&layer_google==true)map.setBaseLayer(gsat);else if(layer_default=="yahoo"&&layer_yahoo==true)map.setBaseLayer(yahoo);else if(layer_default=="yahoosat"&&layer_yahoo==true)map.setBaseLayer(yahoosat);else if(layer_default=="yahoohyb"&&layer_yahoo==true)map.setBaseLayer(yahoohyb);
else if(layer_default=="veroad"&&layer_vearth==true)map.setBaseLayer(veroad);else if(layer_default=="veaer"&&layer_vearth==true)map.setBaseLayer(veaer);else if(layer_default=="vehyb"&&layer_vearth==true)map.setBaseLayer(vehyb);$("#map_selector #maplist li a[name='mapnik']").click(function(e){e.preventDefault();map.setBaseLayer(mapnik);stats("map_layer/osm/mapnik")});$("#map_selector #maplist li a[name='osmarender']").click(function(e){e.preventDefault();map.setBaseLayer(osmarender);stats("map_layer/osm/osmarender")});
if(layer_google==true){$("#map_selector #maplist li a[name='gphy']").click(function(e){e.preventDefault();map.setBaseLayer(gphy);stats("map_layer/google/gphy")});$("#map_selector #maplist li a[name='gmap']").click(function(e){e.preventDefault();map.setBaseLayer(gmap);stats("map_layer/google/gmap")});$("#map_selector #maplist li a[name='ghyb']").click(function(e){e.preventDefault();map.setBaseLayer(ghyb);stats("map_layer/google/ghyb")});$("#map_selector #maplist li a[name='gsat']").click(function(e){e.preventDefault();
map.setBaseLayer(gsat);stats("map_layer/google/gsat")})}if(layer_yahoo==true){$("#map_selector #maplist li a[name='yahoo']").click(function(e){e.preventDefault();map.setBaseLayer(yahoo);stats("map_layer/yahoo/yahoo")});$("#map_selector #maplist li a[name='yahoosat']").click(function(e){e.preventDefault();map.setBaseLayer(yahoosat);stats("map_layer/yahoo/yahoosat")});$("#map_selector #maplist li a[name='yahoohyb']").click(function(e){e.preventDefault();map.setBaseLayer(yahoohyb);stats("map_layer/yahoo/yahoohyb")})}if(layer_vearth==
true){$("#map_selector #maplist li a[name='veroad']").click(function(e){e.preventDefault();map.setBaseLayer(veroad);stats("map_layer/vearth/veroad")});$("#map_selector #maplist li a[name='veaer']").click(function(e){e.preventDefault();map.setBaseLayer(veaer);stats("map_layer/vearth/veaer")});$("#map_selector #maplist li a[name='vehyb']").click(function(e){e.preventDefault();map.setBaseLayer(vehyb);stats("map_layer/vearth/vehyb")})}var hover_marker=new OpenLayers.Control.SelectFeature(places,{hover:true,
highlightOnly:true,renderIntent:"hover"});map.addControl(hover_marker);hover_marker.activate();var select_marker=new OpenLayers.Control.SelectFeature(places,{hover:false,highlightOnly:true,clickout:true,multiple:false,box:false});map.addControl(select_marker);select_marker.activate();markerCountLabels();var select_countrydot=new OpenLayers.Control.SelectFeature(places_count,{onSelect:onCountrydotSelect,onUnselect:onCountrydotUnselect,hover:true,clickout:true,multiple:false,box:false});map.addControl(select_countrydot);
select_countrydot.activate();var overview=new OpenLayers.Control.OverviewMap;map.addControl(overview);overview.maximizeControl();$("#PlacePanel").hide();map.setCenter((new OpenLayers.LonLat(lon,lat)).transform(proj4326,projmerc));if(zoom==false)map.zoomToMaxExtent();else map.zoomTo(zoom);mapEventlisteners=true}
function onCountrydotSelect(feature){var point=feature.geometry.getBounds().getCenterLonLat();if(point.lat>map_center.lat)var lat_offset=5;else var lat_offset=-5;if(point.lon>map_center.lon)var lon_offset=-5;else var lon_offset=5;popup=new OpenLayers.Popup.FramedCloud("Country",point,null,'<div style="color: #111;"><h4 style="margin:0; padding: 0 0 3px 21px; background: url(static/gfx/flags/'+feature.attributes.iso.toLowerCase()+'.png) no-repeat 0 3px;">'+feature.attributes.name+'</h4><small class="grey">'+
feature.attributes.places+" "+_("places")+".<br /><i>"+_("Zoom closer to see them.")+"</i></small></div>",{size:new OpenLayers.Size(15,15),offset:new OpenLayers.Pixel(lon_offset,lat_offset)},false);feature.popup=popup;map.addPopup(popup)}function onCountrydotUnselect(feature){map.removePopup(feature.popup);feature.popup.destroy();feature.popup=null}
function handleMeasurements(event){var geometry=event.geometry;var units=event.units;var order=event.order;var measure=event.measure;var element=document.getElementById("toolOutput");var out="";if(order==1)out+=measure.toFixed(3)+" "+units;else out+=measure.toFixed(3)+" "+units+"<sup>2</"+"sup>";element.innerHTML=out}function toggleControl(element){for(key in measureControls){var control=measureControls[key];if(element.value==key&&element.checked)control.activate();else control.deactivate()}}
function fetchlocation(){if(navigator.geolocation){maps_debug("Browser supports Geolocation. Asking to use it...");navigator.geolocation.getCurrentPosition(fetchlocationW3,fetchlocationByIP)}else{maps_debug("Browser didn't support geolocation. Using our own IP-based service.");fetchlocationByIP()}}
function displaylocation(location){if(location.Status=="OK"){maps_debug("Showing location under search bar.");var show_nearby=false;if(location.City!=""||location.City!=undefined){$("#nearby .locality a").text(location.City).click(function(){search(location.City+", "+location.CountryName)});$("#nearby .locality").show("fast");show_nearby=true}if(location.State!="--"){$("#nearby .state a").text(location.State).click(function(){search(location.State+", "+location.CountryName)});$("#nearby .state").show("fast");
show_nearby=true}else if(location.RegionName!=""){$("#nearby .state a").text(location.RegionName).click(function(){search(location.RegionName+", "+location.CountryName)});$("#nearby .state").show("fast");show_nearby=true}else $("#nearby .state a").text("blaa");if(location.CountryName!=""||location.CountryName!=undefined){$("#nearby .country a").text(location.CountryName).click(function(){search(location.CountryName)});$("#nearby .country").show("fast");show_nearby=true}if(show_nearby==true)$("#nearby").slideDown("fast");
else $("#nearby").hide()}}
function fetchlocationW3(position){maps_debug("Got location from browser. Sending it to the geocoder.");$.getJSON("ajax/geocoder.php?mode=reverse&q="+position.coords.latitude+","+position.coords.longitude,function(data){if(data.error==true){maps_debug("Error when trying to get reverce geocode. Using our own IP-geolocation service");fetchlocationByIP()}else{maps_debug("Geocoded address succesfully.");var location={Status:"OK",Latitude:position.coords.longitude,Longitude:position.coords.latitude,CountryCode:data.country_code,
CountryName:data.country_name,RegionName:"",State:"--",City:data.locality,ZipPostalCode:data.postcode};displaylocation(location)}})}
fetchlocationByIP=function(){maps_debug("Using IP-based geolocation service.");cookiedata=$.cookie(geolocation_cookiename);if(""!=cookiedata){locationinfo=$.evalJSON(cookiedata);if(locationinfo!=null&&locationinfo.IP==ip){displaylocation(locationinfo);$.cookie(geolocation_cookiename,cookiedata,geolocation_cookieoptions);return}}$.getJSON(geolocation,{timezone:"false",ip:ip},function(data){data.IP=ip;displaylocation(data);cookiedata=$.toJSON(data);$.cookie(geolocation_cookiename,cookiedata,geolocation_cookieoptions)})};
function mapEventMove(){if(mapEventlisteners==true)refreshMapMarkers()}function mapEventMoveStarted(){var currentZoom=map.getZoom();if(currentZoom<markersZoomLimit)places.display(false);else places.display(true)}function mapEventZoom(){if(mapEventlisteners==true)maps_debug("Map Zoom: "+map.getZoom())}function mapLayerChanged(){if(mapEventlisteners==true)maps_debug("map layer changed")}function mapBaseLayerChanged(){if(mapEventlisteners==true)maps_debug("map baselayer changed")}
function markerCountLabels(){maps_debug("Gathering marker count labels from the API...");var apiCall="api/?countries&coordinates";maps_debug("Calling API: "+apiCall);$.getJSON(apiCall,function(data){maps_debug("Got labels by JSON. Starting to loop 'em.");var labelStock=[];$.each(data,function(key,value){if(value.lon!=""||value.lat!=""||value.lon!=undefined||value.lat!=undefined){if(value.places>=1E3)var pointRadius=14;else if(value.places>=100)var pointRadius=12;else if(value.places>=10)var pointRadius=
9;else var pointRadius=7;var coords=(new OpenLayers.LonLat(value.lon,value.lat)).transform(proj4326,map.getProjectionObject());labelStock.push(new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(coords.lon,coords.lat),{name:value.name,places:value.places,iso:value.iso,radius:pointRadius}))}else maps_debug("Lat/Lon missing for the label: "+value.name+" ("+value.lat+", "+value.lon+")")});if(labelStock.length>0){maps_debug("Adding "+labelStock.length+" labels to the map.");places_count.addFeatures(labelStock)}else maps_debug("Error: didn't get any labels to add.")})}
var markers=new Array;
function refreshMapMarkers(){var currentZoom=map.getZoom();map_center=map.getCenter();if(currentZoom<markersZoomLimit){places.setVisibility(false);places_count.setVisibility(true)}else{places.setVisibility(true);places_count.setVisibility(false)}if(currentZoom>=markersZoomLimit){var extent=map.getExtent();var corner1=(new OpenLayers.LonLat(extent.left,extent.top)).transform(projmerc,proj4326);var corner2=(new OpenLayers.LonLat(extent.right,extent.bottom)).transform(projmerc,proj4326);var apiCall=
"api/?bounds="+corner2.lat+","+corner1.lat+","+corner1.lon+","+corner2.lon;maps_debug("Calling API: "+apiCall);$.getJSON(apiCall,function(data){maps_debug("Starting markers each-loop...");var markerStock=[];$.each(data,function(key,value){if(markers[value.id]!=true){markers[value.id]=true;var coords=(new OpenLayers.LonLat(value.lon,value.lat)).transform(proj4326,projmerc);markerStock.push(new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(coords.lon,coords.lat),{id:value.id,rating:value.rating}))}else;
});if(markerStock.length>0){maps_debug("Loop ended. Adding "+markerStock.length+" new markers to the map.");places.addFeatures(markerStock)}else maps_debug("Loop ended. No new markers found from this area.")})}}var add_place_initialized_once=false;var add_place_open=false;
function init_add_place(){maps_debug("Initialize adding a new place");close_page();$("#map").click();add_place_open=true;$.ajax({url:"ajax/add_place.php",async:false,success:function(content){$("#PlacePanel").html(content).show();$("#map").attr("style","right:250px;");$("#map_selector").attr("style","right:265px;");handle_add_place_click=true;add_place_target.setVisibility(true);if(add_place_initialized_once==false){maps_debug("Adding layers for new place.");var new_place=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(map.getCenter().lon,
map.getCenter().lat));add_place_target.addFeatures(new_place);var new_place_lon=new_place.geometry.x;var new_place_lat=new_place.geometry.y;update_add_place(new_place_lon,new_place_lat,true);var add_place_drag=new OpenLayers.Control.DragFeature(add_place_target,{onComplete:function(feature){var lat=feature.geometry.y;var lon=feature.geometry.x;new_place.move(new OpenLayers.LonLat(lon,lat));update_add_place(lon,lat,true);maps_debug("Add marker moved (move): "+lat+", "+lon)}});map.addControl(add_place_drag);
add_place_drag.activate();OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:true,"double":false,pixelTolerance:0,stopSingle:false,stopDouble:false},initialize:function(options){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){if(handle_add_place_click!=false&&add_place_open==
true){var new_place_lonlat=map.getLonLatFromViewPortPx(e.xy);new_place.move(new_place_lonlat);update_add_place(new_place_lonlat.lon,new_place_lonlat.lat);maps_debug("Add marker moved (click): "+new_place_lonlat.lat+", "+new_place_lonlat.lon)}}});var new_place_click=new OpenLayers.Control.Click;map.addControl(new_place_click);new_place_click.activate();add_place_initialized_once=true}else maps_debug("Showing old layers for adding a new place.")}})}
function close_add_place(){if(add_place_open==true){add_place_open=false;hidePlacePanel();maps_debug("Closing add Place panel.");add_place_target.setVisibility(false)}}
function update_add_place(q_lon,q_lat,needsConverting){maps_debug("Updating add place -info.");$("#add_new_place_form #address_row").hide();$("#add_new_place_form #loading_row").show();var g_lonLat=(new OpenLayers.LonLat(q_lon,q_lat)).transform(projmerc,proj4326);maps_debug("update_add_place() got coords: "+q_lat+", "+q_lon+" => conv: "+g_lonLat.lat+", "+g_lonLat.lon);$("#add_new_place_form input#lat").val(g_lonLat.lat);$("#add_new_place_form input#lon").val(g_lonLat.lon);$.getJSON("ajax/geocoder.php?mode=reverse&q="+
g_lonLat.lat+","+g_lonLat.lon,function(data){$("#add_new_place_form #loading_row").hide();if(data.error==true){maps_debug("Error when trying to get reverce geocode. Show manual country selector.");$("#add_new_place_form input#country_iso").val("");$("#add_new_place_form #manual_country_selection").show();$("#add_new_place_form #address_row").hide();$("#add_new_place_form input#locality").val("")}else{maps_debug("Got reverce geocode response.");$("#add_new_place_form #manual_country_selection").hide();
$("#add_new_place_form #address_row").show();if(data.address!="")$("#add_new_place_form #address_row #address").html(data.address);else $("#add_new_place_form #address_row #address").text("");if(data.address!=""&&data.country_name!="")$("#add_new_place_form #address_row #address").append("<br />");if(data.locality!=undefined){$("#add_new_place_form input#locality").val(data.locality);$("#add_new_place_form #locality_name").text(data.locality);if(data.country_name!=undefined&&data.country_code!=undefined)$("#add_new_place_form #locality_name").append("<br />");
$("#add_new_place_form #locality_name").show()}else{$("#add_new_place_form input#locality").val("");$("#add_new_place_form #locality_name").hide().text("")}if(data.country_name!=undefined&&data.country_code!=undefined){$("#add_new_place_form #address_row #country_name").text(data.country_name);$("#add_new_place_form #address_row .flag").hide().attr("src","static/gfx/flags/"+data.country_code.toLowerCase()+".png").fadeIn("slow");$("#add_new_place_form input#country_iso").val(data.country_code)}else{$("#add_new_place_form #address_row #country_name").text("");
$("#add_new_place_form #address_row .flag").hide();$("#add_new_place_form input#country_iso").val("");$("#add_new_place_form #manual_country_selection").show()}$("#add_new_place_form #address_row").show()}})}
function showPlacePanel(id,zoomin){maps_debug("Show marker panel for place: "+id);stats("show_place/?place="+id);close_add_place();$.ajax({url:"ajax/place.php?id="+id+"&lang="+locale,async:false,success:function(content){maps_debug("Loaded marker data OK. Show panel.");$("#PlacePanel").html(content).show();$("#map").attr("style","right:250px;");$("#map_selector").attr("style","right:265px;");if(zoomin==true)zoomMapIn($("#PlacePanel #coordinates .lat").text(),$("#PlacePanel #coordinates .lon").text(),
16)}})}function hidePlacePanel(){maps_debug("Hiding Place Panel.");$("#map").css("right","0");$("#map_selector").attr("style","right:15px;");$("#PlacePanel").hide().html("")}
function search(q){maps_debug("Search: "+q);stats("search/?s="+q);close_cards();close_page();show_loading_bar(_("Searching..."));$.ajax({method:"get",url:"ajax/geocoder.php?q="+q,dataType:"json",timeout:7E3,success:function(data){hide_loading_bar();maps_debug("Search results came from: "+data.service+"<br /> - Locality: "+data.locality+"<br /> - Country: "+data.country_code);if(data.boundingbox!=undefined){maps_debug("Moving to the bounding box: "+data.boundingbox);var boundingbox=data.boundingbox.split(",");
bounds=new OpenLayers.Bounds;bounds.extend(new OpenLayers.LonLat(boundingbox[2],boundingbox[0]));bounds.extend(new OpenLayers.LonLat(boundingbox[3],boundingbox[1]));map.zoomToExtent(bounds)}else if(data.lat!=undefined&&data.lon!=undefined){maps_debug("Moving to lat+lon.");if(data.zoom==undefined)searchZoom=5;else searchZoom=data.zoom;zoomMapIn(data.lat,data.lon,searchZoom)}else{maps_debug("Search didn't find anything.");info_dialog("<p>"+_("Your search did not match any places.")+"</p><p>"+_("Try searching in English and add a country name in to your search.")+
"</p><p>"+_("Example:")+" Vilnius, Lithuania.</p>",_("Not found"),false)}},error:function(objAJAXRequest,strError){maps_debug("Search didn't find anything. Error type: "+strError);hide_loading_bar();info_dialog("<p>"+_("Your search did not match any places.")+"</p><p>"+_("Try searching by english city names or/and add a country name with cities."),_("Not found"),false)}});return false}
function zoomMapIn(lat,lon,zoom){maps_debug("Zoom map to a point. "+lat+","+lon);map.setCenter((new OpenLayers.LonLat(lon,lat)).transform(proj4326,projmerc));map.zoomTo(zoom)}function showCountry(country_iso){maps_debug("Information about country "+country_iso);open_page("countries")}
function open_page(name){maps_debug("Open a page: "+name);stats("pages/"+name+"/");if($("#cards .card").is(":visible"))close_cards();$.ajax({url:"ajax/views.php?type=page&lang="+locale+"&page="+name,async:false,success:function(content){if($("#pages .page").is(":hidden")){$("#pages .page .content").html(content).show();$("#pages .page").slideDown("fast");$("#pages .close").show()}else{$("#pages .page .content").html(content);$("#pages .page").attr({scrollTop:0})}return true}})}
function close_page(){maps_debug("Closing a page");if($("#pages .page").is(":visible")){$("#pages .page .content").hide("fast").text("");$("#pages .page").slideUp("fast");$("#pages .close").hide()}}
function open_card(name,title){maps_debug("Open a card: "+name);stats("cards/"+name+"/");if($("#pages .page").is(":visible"))close_page();if($("#card_"+name).size())$("#card_"+name).dialog("close");$.ajax({url:"ajax/views.php?type=card&lang="+locale+"&page="+name,async:false,success:function(content){$("#cards").html('<div class="card" id="card_'+name+'" title="'+title+'">'+content+"</div>");$("#cards .card").dialog({position:[280,100],height:400,width:390,maxHeight:600,maxWidth:650,show:"slide"})}})}
function close_cards(){maps_debug("Closing all cards...");$(".card").dialog("close")}
function removeComment(remove_id){maps_debug("Asked to remove a comment "+remove_id);stats("comment/remove/");var confirm_remove=confirm(_("Are you sure you want to remove this comment?"));if(confirm_remove)$.getJSON("api/?remove_comment="+remove_id,function(data){if(data.success==true){maps_debug("Comment "+remove_id+" removed.");$("#comment_list #comment-"+remove_id).fadeOut("slow");var current_comment_count=$("#comments #comment_counter").text();$("#comments #comment_counter").text(parseInt(current_comment_count)-
1)}else{info_dialog(_("Could not remove comment due error. Please try again!"),_("Error"),true);maps_debug("Could note remove comment. Error: "+data.error)}})}function is_numeric(input){return input-0==input&&input.length>0}
function info_dialog(dialog_info,dialog_title,dialog_alert,reload_page){if(dialog_alert)var dialog_type="alert";else var dialog_type="info";if(dialog_title==undefined)dialog_title=dialog_type;maps_debug("Calling "+dialog_type+"-dialog box; "+dialog_title);$("#dialog-message").attr("title",dialog_title).html('<p><span class="ui-icon ui-icon-'+dialog_type+'" style="float:left; margin:0 7px 50px 0;"></span>'+dialog_info+"</p>").dialog({modal:true,resizable:false,buttons:{Ok:function(){if(reload_page){maps_debug("Reloading the page...");
$("#reloadPage").submit();$(this).dialog("close")}else{$(this).dialog("close");maps_debug("Dialog closed.")}}}});dialog_info=null;dialog_title=null;dialog_alert=false}function show_loading_bar(title){maps_debug("Show loading bar: "+title);if(title!=undefined)$("#loading-bar .title").text(title);else $("#loading-bar .title").text("");if($("#loading-bar").is(":hidden")==true)$("#loading-bar").show()}
function hide_loading_bar(){maps_debug("Hide loading bar.");if($("#loading-bar").is(":visible")==true)$("#loading-bar").fadeOut("slow");$("#loading-bar .title").text("")}function maps_debug(str){if(debug==true){$("#log ul").append("<li>"+str+"</li>").attr({scrollTop:$("#log ul").attr("scrollHeight")});return true}}function stats(str){if(str!=undefined&&str!=""){if(google_analytics==true){maps_debug("Stats: "+str);pageTracker._trackPageview(str)}}else maps_debug("Error: empty stats() request!")};
